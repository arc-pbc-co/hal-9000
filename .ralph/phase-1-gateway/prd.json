{
  "project": "HAL-9000 Refactor",
  "branchName": "ralph/phase-1-gateway",
  "description": "Phase 1: Gateway Foundation - WebSocket server, session management, message routing",
  "userStories": [
    {
      "id": "P1-001",
      "title": "Create gateway protocol definitions",
      "description": "As a developer, I need Pydantic models for the gateway message protocol.",
      "acceptanceCriteria": [
        "Create src/hal9000/gateway/__init__.py",
        "Create src/hal9000/gateway/protocol.py",
        "Define MessageType enum: COMMAND, QUERY, TOOL_CALL, FEEDBACK, RESPONSE, STREAM_CHUNK, STREAM_END, TOOL_RESULT, ERROR, ADAM_PROMPT, ADAM_CONTEXT, ADAM_FEEDBACK",
        "Define GatewayMessage Pydantic model with: id, type, session_id, timestamp, payload, metadata",
        "Define ADAMPromptPayload model for ADAM-specific messages",
        "All models have proper type hints",
        "Typecheck passes",
        "Unit tests in tests/gateway/test_protocol.py pass"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Implemented with full test coverage"
    },
    {
      "id": "P1-002",
      "title": "Create session management",
      "description": "As a gateway, I need to manage client sessions with research context.",
      "acceptanceCriteria": [
        "Create src/hal9000/gateway/session.py",
        "Define ResearchContext dataclass with: documents_analyzed, extracted_knowledge, materials_of_interest, active_hypotheses, adam_interactions",
        "Define Session dataclass with: id, channel, created_at, user_id, context, conversation_history, active_tools",
        "Session has to_context_window() method returning dict for ADAM",
        "Create SessionManager class to track active sessions",
        "SessionManager supports: create_session, get_session, remove_session, list_sessions",
        "Typecheck passes",
        "Unit tests pass"
      ],
      "priority": 2,
      "passes": true,
      "notes": "Implemented with 28 unit tests"
    },
    {
      "id": "P1-003",
      "title": "Create event streaming system",
      "description": "As a gateway, I need to stream events to clients in real-time.",
      "acceptanceCriteria": [
        "Create src/hal9000/gateway/events.py",
        "Define EventType enum for gateway events",
        "Define GatewayEvent Pydantic model",
        "Create EventEmitter class with async generators",
        "EventEmitter supports: emit, subscribe, unsubscribe",
        "Events can be filtered by type",
        "Typecheck passes",
        "Unit tests with pytest-asyncio pass"
      ],
      "priority": 3,
      "passes": true,
      "notes": "Implemented with 28 async tests"
    },
    {
      "id": "P1-004",
      "title": "Create message router",
      "description": "As a gateway, I need to route messages to appropriate handlers.",
      "acceptanceCriteria": [
        "Create src/hal9000/gateway/router.py",
        "Define Router class with route() method",
        "Router dispatches based on MessageType",
        "Router accepts handler registrations per message type",
        "Router returns AsyncGenerator for streaming responses",
        "Unknown message types return error response",
        "Typecheck passes",
        "Unit tests pass"
      ],
      "priority": 4,
      "passes": true,
      "notes": "Implemented with 17 unit tests"
    },
    {
      "id": "P1-005",
      "title": "Create WebSocket server",
      "description": "As a client, I need to connect to HAL-9000 via WebSocket.",
      "acceptanceCriteria": [
        "Create src/hal9000/gateway/server.py",
        "Define HALGateway class",
        "Server listens on configurable host:port (default 127.0.0.1:9000)",
        "Server handles WebSocket connections via websockets library",
        "Each connection creates a Session",
        "Messages are parsed and routed via Router",
        "Responses are streamed back to client",
        "Graceful shutdown on SIGINT/SIGTERM",
        "Typecheck passes",
        "Integration tests pass"
      ],
      "priority": 5,
      "passes": true,
      "notes": "Implemented with 14 integration tests"
    },
    {
      "id": "P1-006",
      "title": "Add gateway CLI command",
      "description": "As a developer, I want to start the gateway from the command line.",
      "acceptanceCriteria": [
        "Add 'hal gateway' command group to src/hal9000/cli.py",
        "Subcommand 'hal gateway start' starts the WebSocket server",
        "Options: --host, --port, --verbose",
        "Shows startup banner with connection URL",
        "Ctrl+C gracefully shuts down",
        "Typecheck passes",
        "Manual verification: run 'hal gateway start' and verify server starts"
      ],
      "priority": 6,
      "passes": true,
      "notes": "CLI verified with hal gateway start --help"
    },
    {
      "id": "P1-007",
      "title": "Add gateway configuration",
      "description": "As a developer, I need gateway settings in the config system.",
      "acceptanceCriteria": [
        "Add GatewaySettings class to src/hal9000/config.py",
        "Settings: host, port, max_connections, session_timeout_minutes",
        "Environment variable support: HAL9000_GATEWAY__HOST, etc.",
        "Integrate with existing Hal9000Settings",
        "Typecheck passes",
        "Unit tests pass"
      ],
      "priority": 7,
      "passes": true,
      "notes": "Implemented with env var support and unit tests"
    },
    {
      "id": "P1-008",
      "title": "Create gateway health check",
      "description": "As a client, I need to check if the gateway is healthy.",
      "acceptanceCriteria": [
        "Add health check endpoint to gateway",
        "Responds to QUERY message with type 'health'",
        "Returns: status, uptime, active_sessions, version",
        "Typecheck passes",
        "Integration test verifies health check response"
      ],
      "priority": 8,
      "passes": true,
      "notes": "Implemented with 16 unit tests in test_health.py"
    },
    {
      "id": "P1-009",
      "title": "Add database session persistence",
      "description": "As a user, I want my research sessions to persist across gateway restarts.",
      "acceptanceCriteria": [
        "Add Session SQLAlchemy model to src/hal9000/db/models.py",
        "Fields: id, channel, user_id, created_at, last_active, context (JSON), conversation_history (JSON)",
        "SessionManager loads existing sessions from DB on startup",
        "SessionManager saves session state on changes",
        "Sessions older than timeout are cleaned up",
        "Typecheck passes",
        "Unit tests pass"
      ],
      "priority": 9,
      "passes": false,
      "notes": ""
    },
    {
      "id": "P1-010",
      "title": "Integration test: full gateway flow",
      "description": "As a developer, I need end-to-end tests for the gateway.",
      "acceptanceCriteria": [
        "Create tests/gateway/test_integration.py",
        "Test: connect, send message, receive response",
        "Test: session creation and retrieval",
        "Test: streaming response handling",
        "Test: error handling for invalid messages",
        "Test: graceful disconnect",
        "All tests pass with pytest-asyncio"
      ],
      "priority": 10,
      "passes": false,
      "notes": ""
    }
  ]
}
